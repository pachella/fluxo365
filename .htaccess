# Ativar reescrita
RewriteEngine On
RewriteBase /

# Forçar HTTPS (SSL)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Desabilitar listagem de diretórios
Options -Indexes

# Bloquear acesso direto a diretórios sensíveis
RewriteCond %{REQUEST_URI} ^/(core|views)/
RewriteRule .* - [F,L]

# Permitir serve_image.php explicitamente
RewriteCond %{REQUEST_URI} ^/serve_image\.php
RewriteRule . - [L]

# Evitar reescrita de arquivos do sistema e recursos estáticos
RewriteCond %{REQUEST_URI} ^/modules/.*\.(css|js|png|jpg|gif|ico|svg|woff|woff2|ttf|pdf|doc|docx)$ [OR]
RewriteCond %{REQUEST_URI} ^/webhooks/ [OR]
RewriteCond %{REQUEST_URI} \.(css|js|png|jpg|gif|ico|svg|woff|woff2|ttf)$
RewriteRule . - [L]

# ===================================================================
# ROTAS AMIGÁVEIS
# ===================================================================

# Formulário público: /f/ID
RewriteRule ^f/([0-9]+)$ /modules/forms/public/view.php?id=$1 [L,QSA]

# Respostas de formulário: /forms/ID/responses
RewriteRule ^forms/([0-9]+)/responses/?$ /modules/forms/responses/list.php?id=$1 [L,QSA]

# Visualizar resposta: /forms/ID/responses/ID
RewriteRule ^forms/([0-9]+)/responses/([0-9]+)$ /modules/forms/responses/view.php?id=$2 [L,QSA]

# Exportar respostas: /forms/ID/responses/export
RewriteRule ^forms/([0-9]+)/responses/export$ /modules/forms/responses/export.php?id=$1 [L,QSA]

# Construtor de formulário: /forms/builder/ID
RewriteRule ^forms/builder/([0-9]+)$ /modules/forms/builder/index.php?id=$1 [L,QSA]

# Editor de formulário: /forms/ID/edit (se precisar)
RewriteRule ^forms/([0-9]+)/edit$ /modules/forms/edit.php?id=$1 [L,QSA]

# Duplicar formulário: /forms/ID/duplicate
RewriteRule ^forms/([0-9]+)/duplicate$ /modules/forms/duplicate.php?id=$1 [L,QSA]

# Deletar formulário: /forms/ID/delete
RewriteRule ^forms/([0-9]+)/delete$ /modules/forms/delete.php?id=$1 [L,QSA]

# Lista de formulários: /forms/list
RewriteRule ^forms/list$ /modules/forms/list.php [L,QSA]

# Permitir acesso direto a endpoints de API (POST/AJAX)
RewriteCond %{REQUEST_METHOD} POST [OR]
RewriteCond %{HTTP_X_REQUESTED_WITH} XMLHttpRequest
RewriteCond %{REQUEST_URI} ^/modules/
RewriteRule . - [L]

# Remover .php das URLs (redirecionar para versão sem extensão)
RewriteCond %{THE_REQUEST} \s/+(.+)\.php[\s?] [NC]
RewriteCond %1 !^(modules|webhooks|core)
RewriteRule ^ /%1? [R=301,L]

# Permitir acesso sem .php (reescrita interna)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !^/(modules|webhooks|core)
RewriteCond %{DOCUMENT_ROOT}/$1.php -f
RewriteRule ^([^/]+(?:/[^/]+)*)/?$ $1.php [L]

# Alias dashboard
RewriteRule ^dashboard/?$ modules/dashboard.php?page=dashboard/home [L,QSA]

# Roteamento do dashboard
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^/]+)/?(.*)$ modules/dashboard.php?page=$1/$2 [L,QSA]